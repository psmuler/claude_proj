# 俳句データベース移行仕様書

## プロジェクト概要

**目的**: スプレッドシートベースの俳句DBから本格的なデータベースへの移行  
**課題**: 1万行の俳句データでID検索時に全行読み込みによるパフォーマンス問題  
**目標**: 高速検索・CRUD操作・ユーザー投稿機能の実現

## 現在のデータ構造

### 俳句テーブル（10,000行 × 14列）
- 俳句本文、作者ID、詠まれた場所、投稿日時等のデータ
- 詠み人テーブルとのリレーション有り

### 詠み人テーブル（100行 × 9列）  
- 作者情報、プロフィール等のマスターデータ

## データベース選択肢の比較

### Supabase

**メリット:**
- PostgreSQLベースで高いクエリ性能
- リレーショナルデータに最適
- リアルタイム機能標準搭載
- Row Level Security（将来の権限管理に対応可能）
- 無料枠で十分対応可能（500MB DB、50,000 API呼び出し/月）

## アーキテクチャ（Supabase）

### データベーススキーマ

```sql
-- 詠み人テーブル
CREATE TABLE poets (
    -- 後ほど追記。現在の列名は、id	name	name_kana	birth_year	death_year	period	biography	created_at	updated_at
);

-- 俳句テーブル
CREATE TABLE haikus (
  -- 後ほど追記。現在の列名は、id	haiku_text	poet_id	latitude	longitude	location_type	date_composed	location_name	date_composed_era	description	season	seasonal_term	created_at	updated_at
);

-- インデックス設定（パフォーマンス最適化）
後ほど追記

-- 全文検索インデックス（俳句本文検索用）
後ほど追記
```
### API設計
- RESTful APIエンドポイント設計
- 俳句・詠み人のCRUD操作
- 検索・フィルタリング機能
- 一括CSVアップロードエンドポイント（後ほど）
- 一括句碑写真アップロードエンドポイント（後ほど）


## 実装手順

### Phase 1: 環境構築（1日）
1. Supabaseプロジェクト作成
2. データベーススキーマ作成
3. サンプルデータ投入・テスト

### Phase 2: データ移行（2-3日）
1. スプレッドシートからCSVエクスポート
2. データクレンジング・正規化
3. Supabaseへのデータインポート
4. データ整合性確認

### Phase 3: API実装（3-4日）
1. Supabase クライアント設定
2. 基本CRUD操作の実装
3. 検索・フィルタリング機能

### Phase 4: フロントエンド改修（2-3日）
1. 既存のスプレッドシート連携コード削除
2. Supabase APIへの置き換え
3. エラーハンドリング改善
4. ローディング状態の改善

### Phase 5: テスト・最適化（1-2日）
1. パフォーマンステスト
2. クエリ最適化
3. ユーザー受入テスト

## パフォーマンス最適化戦略

### データベースレベル
- 適切なインデックス設定
- クエリプランの確認・最適化
- Connection poolingの活用

### アプリケーションレベル
- キャッシュ戦略（人気の俳句・作者）
- 遅延読み込み（Lazy loading）

### フロントエンドレベル
- ピン地点表示（クラスタ表示）
- 検索結果のデバウンス処理
- プリフェッチング（次ページデータ）

## 地図機能の実装


### データ移行リスク
- **リスク**: データ不整合・欠損
- **対策**: 段階的移行、ロールバック計画

### パフォーマンスリスク  
- **リスク**: 想定以上のトラフィック
- **対策**: モニタリング設定、スケーリング計画

### 運用リスク
- **リスク**: データベース障害
- **対策**: Supabaseの高可用性機能活用

## 成功指標

- ID検索の応答時間: 100ms以下
- 一般検索の応答時間: 500ms以下  
- 同時ユーザー: 100人まで対応
- データ整合性: 100%維持

## 次フェーズの拡張案
- 一括CSVアップロードエンドポイント（後ほど）
- 一括句碑写真アップロードエンドポイント（後ほど）